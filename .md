# âš¡ Backend API - HV Battery Sequence

Backend service untuk mengelola **sequence data battery**.  
Stack: **Express + TypeScript + Prisma + SQL Server**

---

## ğŸ“¡ API Endpoints

Base URL: `http://localhost:4001/api/sequences`

| Method | Endpoint         | Deskripsi                       |
| ------ | ---------------- | ------------------------------- |
| GET    | `/`              | Ambil semua sequences           |
| POST   | `/`              | Tambah sequence baru            |
| PUT    | `/:id`           | Update sequence                 |
| DELETE | `/:id`           | Hapus sequence permanen         |
| PATCH  | `/:id/move-up`   | Geser sequence ke atas (queue)  |
| PATCH  | `/:id/move-down` | Geser sequence ke bawah (queue) |
| PATCH  | `/:id/park`      | Pindahkan sequence ke parked    |
| PATCH  | `/:id/insert`    | Insert parked ke queue          |
| DELETE | `/:id/parked`    | Hapus sequence dari parked      |

---

## ğŸ“¦ NPM Scripts

Tambahkan di `package.json`:

```json
"scripts": {
  "dev": "tsx watch src/index.ts",        // Run server di dev mode (hot reload)
  "build": "tsc",                         // Compile TypeScript ke JavaScript
  "start": "node dist/src/index.js",      // Run hasil build (production)

  // Prisma workflow
  "migrate": "prisma migrate dev",        // Jalankan migration di dev
  "migrate:deploy": "prisma migrate deploy", // Deploy migration di production
  "generate": "prisma generate",          // Generate Prisma client
  "seed": "tsx prisma/seed.ts",           // Jalankan seed data
  "db:pull": "prisma db pull",            // Introspect schema dari DB existing
  "db:push": "prisma db push",            // Push schema ke DB (âš  hati-hati overwrite)
  "studio": "prisma studio"               // Buka Prisma Studio (GUI DB explorer)
}
```

ğŸ”¹ Step di SQL Server (SSMS)

## Enable Change Tracking di Database:

ALTER DATABASE DB_TMMIN1_KRW_PIS_HV_BATTERY
SET CHANGE_TRACKING = ON
(CHANGE_RETENTION = DAYS, AUTO_CLEANUP = ON);

## Enable Change Tracking di Tabel:

ALTER TABLE dbo.TB_R_SEQUENCE_BATTERY
ENABLE CHANGE_TRACKING
WITH (TRACK_COLUMNS_UPDATED = ON);

## Buat cursor table (simpen last version):

CREATE TABLE CDC_CURSOR (
id INT PRIMARY KEY CHECK (id = 1),
last_version BIGINT NULL,
updated_at DATETIME DEFAULT GETDATE()
);

## -- seed row biar ga error

INSERT INTO CDC_CURSOR (id, last_version) VALUES (1, NULL);

## see ws\sequencePoller.ts (Versi CT)

# Tutorial: Menambahkan Tabel Baru ke Prisma Schema

## Langkah-langkah

1.  **Buat Tabel di Database (SQL Server):**

    - Buat tabel baru kamu di database `DB_TMMIN1_KRW_PIS_HV_BATTERY` menggunakan SQL Server Management Studio (SSMS) atau tool lainnya.
    - **Sangat penting:** Pastikan tabel kamu memiliki **Primary Key** (atau setidaknya kolom unik yang bisa kamu tentukan nanti di `schema.prisma`). Jika tidak, Prisma akan mengabaikan tabel tersebut saat `db pull`, seperti yang sudah kamu alami sebelumnya.

2.  **Tarik Skema dari Database (`db:pull`):**

    - Buka terminal/command prompt kamu.
    - Pastikan kamu berada di direktori `backend` kamu (misalnya `D:\Risyan\Project\PIS-688D-HEV-BATTERY - TMMIN 1 - KRW\DEV\Web App\HV-BATTERY-P1\backend`).
    - Jalankan perintah berikut:
      ```bash
      npm run db:pull
      ```
    - Perintah ini akan membaca struktur database kamu dan **memperbarui file `prisma/schema.prisma`** kamu dengan model baru yang sesuai dengan tabel yang baru kamu buat.
    - Jika tabel kamu memiliki Primary Key, Prisma seharusnya akan membuat model Prisma yang lengkap untuk tabel tersebut tanpa `@@ignore`.

3.  **(Opsional) Jika Tabel Tidak Punya Primary Key:**

    - Jika kamu _tidak_ bisa (atau tidak ingin) menambahkan Primary Key di database untuk tabel tertentu, `db pull` akan menambahkan model tabel tersebut ke `schema.prisma` dengan komentar `/// The underlying table does not contain a valid unique identifier...` dan anotasi `@@ignore`.
    - Untuk bisa menggunakan tabel ini dengan Prisma Client, kamu **harus** mengedit file `schema.prisma` secara **manual**:

      - Buka file `prisma/schema.prisma`.
      - Temukan model tabel baru kamu (misalnya `model TB_NAMA_TABEL_BARU { ... }`).
      - Hapus baris `@@ignore`.
      - Identifikasi kombinasi kolom di tabel kamu yang **seharusnya unik** (misalnya, kolom `id_transaksi` + `kode_barang`).
      - Tambahkan anotasi `@@unique([kolom1, kolom2, ...])` atau `@@id([kolom1, kolom2, ...])` ke model tersebut, menggunakan kombinasi kolom yang kamu identifikasi. Contoh:

        ```prisma
        model TB_NAMA_TABEL_BARU {
          kolom1 String
          kolom2 Int
          kolom3 DateTime?
          // ... kolom lainnya

          @@unique([kolom1, kolom2]) // Kombinasi kolom1 dan kolom2 dianggap unik
        }
        ```

      - Simpan file `schema.prisma`.

4.  **Generate Ulang Prisma Client (`generate`):**
    - Setelah `schema.prisma` diperbarui (baik secara otomatis oleh `db pull` maupun secara manual), kamu perlu menghasilkan ulang Prisma Client agar kode TypeScript kamu bisa mengenali model tabel baru tersebut.
    - Di terminal yang sama (masih di direktori `backend`), jalankan:
      ```bash
      npm run generate
      ```
    - Jika berhasil, kamu akan melihat output seperti `âœ” Generated Prisma Client (...) to ...`.






    ## ğŸš€ Deployment dengan Podman

### Build & Export Image untuk Production

1. **Pastikan Podman Desktop/service sedang berjalan di PC development**

2. **Build project & image**:
   ```cmd
   cd backend
   npm run deploy



   script deploy akan: compile TypeScript â†’ build image my-be:latest â†’ save ke file my-be.tar 


   File hasil export:
File my-be.tar akan muncul di folder backend/
Ini adalah image container yang siap di-deploy
Deploy ke PC Server
Copy file my-be.tar ke PC server (via flashdisk, network share, dll)
Di PC server (sudah terinstall Podman Desktop):
Buka Podman Desktop
Klik tab Images
Klik Import â†’ pilih file my-be.tar
Setelah import selesai, image my-be:latest akan muncul
Jalankan container:
Klik image my-be:latest â†’ klik Run
Set port mapping: 4001:4001
Tambahkan environment variables (jika dibutuhkan):


1
2
DATABASE_URL=sqlserver://[IP-SQL-SERVER]:1433;database=DB_TMMIN1_KRW_PIS_HV_BATTERY;user=sa;password=aas;trustServerCertificate=true
PORT=4001
Klik Run
Verifikasi:
Backend seharusnya bisa diakses di http://[IP-PC-SERVER]:4001
Pastikan SQL Server bisa diakses dari PC server





ğŸ“ Backend (Express + Prisma)

prisma/
â””â”€â”€ schema.prisma          â†’ tambah model baru (kalau perlu DB)

src/
â”œâ”€â”€ services/              â†’ logika bisnis
â”‚   â””â”€â”€ {namaFitur}.service.ts
â”‚
â”œâ”€â”€ controllers/           â†’ handler HTTP
â”‚   â””â”€â”€ {namaFitur}.controller.ts
â”‚
â”œâ”€â”€ routes/                â†’ definisi endpoint
â”‚   â””â”€â”€ {namaFitur}.routes.ts
â”‚
â””â”€â”€ app.ts (atau main)     â†’ daftarkan router:
                             app.use('/api/{nama-endpoint}', route)

FE (hook) â†’ service â†’ API (Express) â†’ controller â†’ service â†’ Prisma â†’ DB
